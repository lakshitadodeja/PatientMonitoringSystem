<html> 
    <head>
        <link href="style.css" rel="stylesheet">
		<script type="text/javascript" src="dygraph.js"></script>
		<link rel="stylesheet" src="dygraph.css"/>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.8.2/firebase.js"></script>
		<script src="js/index.js"></script>
		<script src="js/add.js"></script>
		<script type="text/javascript" src="https://cdn.emailjs.com/dist/email.min.js"></script>
		<script type="text/javascript">
		   (function(){
			  emailjs.init("user_5V32Xb4tMB7JqbeQRn2bc");
		   })();
		   
		</script>
    </head>
<body>
<div class="fixed-top" id="mainNav">
    <p class="navbar-brand" href="index.html">Patient Monitoring System <span style="float:right;margin-right:10px;padding:5px;"><a id="newp" href="newpatient.html">Add a new patient</a></span></p>
    
    </div>
   
    <div id="content">
    <div class="sidenav" id="panel1">
        <ul class="list1">
          
            <li class="list_item">Enter the Patient ID</li>
            <li class="list_item"><form><input type="text" id="PID">
                </input>&nbsp; &nbsp;</form><button value="Go" style="background-color:#aaa;font-size:13px;" onclick="drawGraph() api();">Go</button></li>
        </ul>
		
        <ul class="list2">
        </ul>
   
    </div>

     <div class="container-fluid">
		<div id = "image_div">
			 <img src="medical.gif" style="height: 251px;width: 300px;margin-left: 274px;margin-top: 50px;"><br><br>
			 <img style="margin-left:120px" src="monitor.jpg"/>
			 <img src="alert.jpg"/>
			 <img src="care.jpg">
		 </div>
		<div id = "div_g_temp" style = "display:none;width:300px; height:200px;margin-top:50px"></div>
		<div id = "div_g_hb" style = "display:none"></div>
		<div id = "div_g_bp" style = "display:none"></div>
    </div>
</div>
    <script>
		function drawGraph(){
			$(document).ready(function () {
				  var patient_id = document.getElementById('PID').value;
				  console.log(patient_id);
				  var elem = document.getElementById('image_div');
				  elem.style.display = 'none';
				  var elem1 = document.getElementById('div_g_temp');
				  elem1.style.display = 'block';
				  var elem2 = document.getElementById('div_g_hb');
				  elem2.style.display = 'block';
				  var elem3 = document.getElementById('div_g_bp');
				  elem3.style.display = 'block';
				  var data = [];
				  var g_temp = new Dygraph(elem1, data,
									  {
										drawPoints: true,
										showRoller: true,
									  
										labels: ['Time', 'Temperature']
									  });
				  // It sucks that these things aren't objects, and we need to store state in window.
				  window.intervalId = setInterval(function() {
					var x = new Date();  // current time
					var data_temp;
					var playersRefss = firebase.database().ref("patient_data/"+patient_id);
					playersRefss.on("value", function(data) {
					data.forEach(function(data) {
					  if(data.key == "temperature")
						data_temp = data.val();
					  console.log("The " + data.key + " rating is " + data.val());
						});
					});
					data.push([x, parseInt(data_temp)]);
					g_temp.updateOptions( { 'file': data } );
				  }, 30000);
				}
			);
		}
	</script>
	<script>
		function api(){
		window.intervalId=setInterval(function(){ 
			var temp,bp_high,bp_low,heartbeat,patient_id;
			var playersRefss = firebase.database().ref();
			playersRefss.on("value",function(data){
			data.forEach(function(data) {
			 if(data.key=="temperature")
			 temp=data.val();
			 if(data.key=="heartbeat")
			 heartbeat=data.val();
			if(data.key=="bp_high")
			 bp_high=data.val();
			if(data.key=="bp_low")
			 bp_low=data.val();
			 if(data.key=="patient_id")
			 patient_id=data.val();
			 checkValues(patient_id,temp,bp_high,bp_low,heartbeat);
			});
			
		});	
		},60000);}
		function checkValues(patient_name,temp,bp_high,bp_low,heartbeat)
		{
			if(temp>=101)
			{
				notifyNurse(patient_name);
			}
			
			if(temp>=103)
			{
				notifyDoctor(did,patient_name);
			}
			if(bp_high>=120)
			{
				notifyNurse(patient_name);
			}
			if(bp_high>=140)
			{
				notifyDoctor(did,patient_name);
			}
			if(bp_low<=60)
			{
				notifyNurse(patient_name);
			}
			if(bp_low<=40)
			{
				notifyDoctor(did,patient_name);	
			}
			if(heartbeat>=100)
			{
				notifyNurse(patient_name);
			}
			if(heartbeat>=140)
			{
				notifyDoctor(did,patient_name);	
			}
		}
		function notifyDoctor(did,patient_name)
		{
			//fetch doctor details from table
			emailjs.send("lakshita.dodeja@gmail.com", "template_bhUPhkQ1", {"email":doctor_email,"message_html":patient_name});
			message="http://api.msg91.com/api/sendhttp.php?sender=PaMoAp&route=4&mobiles="+doctor_phone_no+"&authkey=169848A1IDvuQD5991589c&message=Patient "+ patient_name +"in Distress";
			$.ajax({url:message:,type:"GET"});
				
		}

		function notifyNurse(patient_name)
		{
			emailjs.send("lakshita.dodeja@gmail.com", "template_bhUPhkQ1", {"email":"deepika.juneja00@gmail.com","message_html":patient_name});
			message="http://api.msg91.com/api/sendhttp.php?sender=PaMoAp&route=4&mobiles=7404382334&authkey=169848A1IDvuQD5991589c&message=Patient "+ patient_name +"in Distress";
			$.ajax({url:message:,type:"GET"});
		}
		
	</script>
    </body>
</html>